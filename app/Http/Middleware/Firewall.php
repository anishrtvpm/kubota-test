<?php declare(strict_types=1);

namespace App\Http\Middleware;

use Closure;
use Illuminate\Auth\Access\AuthorizationException;
use Illuminate\Http\Request;
use Symfony\Component\HttpFoundation\IpUtils;

final class Firewall
{
    private const ALLOWED_IPS = [
        '127.0.0.1', // 例) ローカルからのアクセスは許可
       
        '103.72.179.127', // Anish.R IP
        '103.154.37.134', // Nikhil IP
        '103.121.27.178', // Experion office 1
        '103.79.223.18', // Experion office 2


        '172.17.0.1/16', // 例) サブネットマスクで範囲指定も可能(docker networkのIP range)
        '192.168.125.1/24',
        '::1',
        '58.191.155.86',
        '58.156.177.134',
        '122.218.103.202',
        '113.32.45.202',
        '113.32.45.210',
        '58.80.8.192/29',
        '133.253.0.0/16',
        '138.91.17.178',
        '138.91.17.193',
        '138.91.17.229',
        '138.91.17.24',
        '213.198.80.161',
        '213.198.52.86',
        '212.119.15.70',
        '66.212.170.81',
        '66.212.170.82',
        '66.212.170.83',
        '66.212.170.84',
        '66.212.170.85',
        '66.212.170.86',
        '66.212.170.87',
        '66.212.170.88',
        '66.212.170.89',
        '66.212.170.90',
        '66.212.170.91',
        '66.212.170.92',
        '66.212.170.93',
        '66.212.170.94',
        '66.212.170.95',
        '66.212.170.96',
        '67.226.175.177',
        '67.226.179.9',
        '209.15.92.223',
        '62.206.89.155',
        '195.158.183.1/27',
        '80.155.167.224/27',
        '83.217.244.200/27',
        '212.210.187.50',
        '95.244.196.172',
        '82.184.179.62',
        '82.184.179.63',
        '85.34.228.38',
        '194.250.185.121',
        '50.201.160.93',
        '50.201.160.194',
        '50.252.122.117',
        '208.68.2.2',
        '180.222.157.66',
        '180.222.149.164',
        '221.228.242.82',
        '107.7.43.78',
        '12.29.79.146',
        '66.64.166.176/28',
        '50.224.16.70',
        '203.42.236.192/29',
        '203.35.75.64/28',
        '203.35.75.65/28',
        '150.207.160.33',
        '144.139.228.85',
        '150.207.153.187',
        '116.50.58.180',
        '49.255.144.7',
        '203.52.221.234',
        '85.115.52.0/24',
        '85.115.56.0/24',
        '116.50.59.0/24',
        '85.115.60.0/24',
        '85.115.58.0/24',
        '85.115.62.0/24',
        '208.87.233.0/24',
        '208.87.234.0/24',
        '85.115.32.0/24',
        '85.115.54.0/24',
        '116.50.57.0/24',
        '208.87.237.0/24',
        '208.87.239.0/24',
        '177.39.96.0/24',
        '208.87.238.0/24',
        '116.50.60.0/24',
        '196.216.238.0/24',
        '116.50.61.0/24',
        '85.115.37.0/24',
        '85.115.33.0/24',
        '208.87.235.0/24',
        '85.115.53.0/24',
        '85.115.39.0/24',
        '208.87.236.0/24',
        '85.115.35.0/24',
        '192.151.178.0/24',
        '222.153.3.24',
        '165.225.98.0/24',
        '165.225.114.0/23',
        '124.248.141.0/24',
        '204.2.206.114',
        '198.87.52.98',
        '74.84.168.187',
        '62.173.120.203',
        '79.99.74.160/27',
        '114.30.81.108',
        '118.96.128.205',
        '125.166.225.97',
        '114.30.81.75',
        '36.78.223.216',
        '114.30.81.82',
        '119.82.245.67',
        '119.82.245.68',
        '112.109.20.164',
        '112.109.20.163',
        '203.89.28.78',
        '114.6.180.248',
        '114.6.180.249',
        '114.6.197.62',
        '114.6.180.247',
        '202.93.228.170',
        '202.93.228.229',
        '202.93.228.230',
        '202.93.228.231',
        '180.222.157.91',
        '180.222.157.92',
        '180.222.157.93',
        '180.222.157.94',
        '180.222.154.180',
        '180.222.155.234',
        '211.232.105.193',
        '211.45.122.193',
        '211.38.3.129',
        '221.159.147.206',
        '211.38.3.159',
        '221.159.147.195',
        '220.85.69.30',
        '111.93.97.181/30',
        '49.248.250.238',
        '49.248.248.78',
        '202.149.218.182',
        '180.179.234.218',
        '114.143.74.22',
        '182.73.189.182',
        '182.72.157.190',
        '61.155.29.10',
        '58.210.55.66',
        '221.224.77.138',
        '80.59.189.61',
        '83.56.46.46',
        '166.102.14.242',
        '203.81.73.222',
        '203.81.92.189',
        '69.160.0.14',
        '74.50.215.206',
        '180.250.72.98',
        '122.53.82.226/27',
        '122.3.84.107/29',
        '122.3.74.228/29',
        '122.3.173.234/29',
        '209.146.18.26/30',
        '78.186.136.13',
        '212.156.38.142',
        '85.96.195.34',
        '113.161.168.93/30',
        '118.163.158.121',
        '219.92.53.83',
        '219.92.53.82',
        '124.13.213.161',
        '210.186.143.223',
        '175.145.84.88',
        '60.52.68.52',
        '183.171.102.108',
        '115.135.14.154',
        '115.133.39.85',
        '60.48.33.151',
        '115.133.229.176',
        '175.138.86.217',
        '118.100.191.193',
        '200.52.203.122',
        '58.191.6.1',
        '58.191.6.2',
        '58.191.6.3',
        '58.191.6.4',
        '58.191.6.5',
        '58.191.6.6',
        '58.191.6.33',
        '58.191.6.34',
        '58.191.6.35',
        '58.191.6.36',
        '58.191.6.37',
        '58.191.6.38',
        '122.218.103.200/29',
        '113.32.45.200/29',
        '77.247.7.90',
        '31.204.81.226/29',
        '62.96.176.42/30',
        '2.117.114.118',
        '2.59.147.112/28',
        '77.247.15.66',
        '162.142.112.8/29',
        '162.142.112.0/29',
        '162.142.112.16/29',
        '185.133.214.70/30',
        '122.53.82.236/27',
        '62.133.20.164',
        '180.148.4.94',
        '49.229.23.228/28',
        '49.229.23.244/28',
        '217.110.106.241',
        '217.110.106.242',
        '217.110.106.240/29',
        '185.133.214.80/30',
        '59.158.119.162',
        '49.229.36.145',
        '115.111.189.210',
        '115.111.189.209',
        '115.111.189.211',
        '115.111.189.212',
        '115.243.64.138',
        '14.140.241.90',
        '115.133.239.182',
        '177.94.219.134',
        '77.247.15.61',
        '77.247.15.62',
        '77.247.15.59',
        '115.84.76.146',
        '183.182.103.87',
        '119.15.88.6',
        '144.48.51.194',
        '14.99.254.98',
        '122.218.103.203',
        '122.218.103.204',
        '122.218.103.205',
        '122.218.103.206',
        '113.32.45.203',
        '113.32.45.204',
        '113.32.45.205',
        '113.32.45.206',
        '218.251.49.179',
        '183.77.123.216',
        '122.103.250.163',
        '202.241.184.112',
        '219.75.233.115',
        '160.86.236.203',
        '210.249.67.249',
        '210.249.67.251',
        '203.114.218.51',
        '118.22.31.145',
        '153.246.92.200',
    ];

    /**
     * Handle an incoming request.
     *
     * @param Request $request
     * @param Closure $next
     * @return mixed
     * @throws AuthorizationException
     */
    public function handle(Request $request, Closure $next)
    {       
        // Bypass local env and check for allowed IP Address
        if (config('app.env') === 'local' || $this->isAllowedIp($request->ip())) {            
            return $next($request);
        }
        throw new AuthorizationException(__('ip_restriction_message'));
    }

    /**
     * @param string $ip
     * @return bool
     */
    private function isAllowedIp(string $ip): bool
    {
        return IpUtils::checkIp($ip, self::ALLOWED_IPS);
    }

    
}